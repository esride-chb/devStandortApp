var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define(["require","exports","esri/Color","esri/rest/support/Query","esri/views/MapView","esri/WebMap","esri/widgets/Expand","esri/widgets/Locate","esri/widgets/Search","./filter","./popup"],function(e,t,r,u,n,i,a,o,l,p,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.updateFilterIcon=t.setFilter=void 0,r=__importDefault(r),u=__importDefault(u),n=__importDefault(n),i=__importDefault(i),a=__importDefault(a),o=__importDefault(o),l=__importDefault(l);var c,d,f,h,b,m=!0,g=[],w="1=1",y=new i.default({portalItem:{id:"02fbadc5dd45470487dbcc9b998c1dc1"}}),v=(y.when().then(function(){for(var e,t=[],r=decodeURI(window.location.search).substring(1).split("&"),n=0;n<r.length;n++)0<r[n].length&&(e=r[n].split("="),t.push({attribute:e[0],value:e[1]}));var i="1=1",o=(t.forEach(function(e){i=i+" AND ("+e.attribute+"='"+e.value+"')","Hauptsäule"===e.attribute?(0,p.updateCheckBoxesForFilter)(!0,e.value):"Unterbereich"===e.attribute?(0,p.updateCheckBoxesForFilter)(!1,e.value):w=w+" AND ("+e.attribute+"='"+e.value+"')"}),y.layers.forEach(function(e){var t;"feature"===e.type&&(0<=(t=e).url.indexOf("Standort")?(t.definitionExpression?(f=t.definitionExpression,t.definitionExpression=t.definitionExpression+"AND ("+i+")"):t.definitionExpression=i,null!==t.featureReduction&&(t.featureReduction.popupEnabled=!0,t.featureReduction.popupTemplate=s.popupTemplateCluster,v.whenLayerView(e).then(function(e){c=e})),t.popupTemplate=s.popupTemplateStandort,g.push(t)):(t.popupTemplate=void 0,t.popupEnabled=!1,0<=t.url.indexOf("Regionen")&&(t.popupTemplate=s.popupTemplateRegionen,d=t)))}),new u.default),o=(o.where=f?f+"AND ("+i+")":i,o.outFields=["*"],o.returnGeometry=!1,0<g.length&&null!=g[0]&&(g[0].queryFeatures(o).then(function(e){e.features.forEach(function(t){var e;null!=t.attributes.Unterbereich&&((e=s.rubrikenForStandort.find(function(e){return e.id===t.attributes.Standort+"_"+t.attributes.Gesellschaft}))?e.rubriken.find(function(e){return e.name===t.attributes.Unterbereich})||e.rubriken.push({name:t.attributes.Unterbereich,url:t.attributes.Unterbereichsdomaine}):s.rubrikenForStandort.push({id:t.attributes.Standort+"_"+t.attributes.Gesellschaft,rubriken:[{name:t.attributes.Unterbereich,url:t.attributes.Unterbereichsdomaine}]}))})}).catch(function(e){console.error("Error query Rubriken for Popup",e)}),(o=new u.default).outFields=["Hauptsäule","Unterbereich","Rubrik"],o.orderByFields=["Hauptsäule","Unterbereich","Rubrik"],o.returnDistinctValues=!0,o.returnGeometry=!1,0<g.length)&&null!=g[0]&&(o.where=f?f+" AND (Unterbereich IS NOT NULL)":"Unterbereich IS NOT NULL",g[0].queryFeatures(o).then(function(e){var r=[],n=[];e.features.forEach(function(t){var e=r.find(function(e){return e.id===t.attributes.Hauptsäule}),e=(e?e.unterbereiche.find(function(e){return e===t.attributes.Unterbereich})||e.unterbereiche.push(t.attributes.Unterbereich):r.push({id:t.attributes.Hauptsäule,unterbereiche:[t.attributes.Unterbereich]}),n.find(function(e){return e.id===t.attributes.Unterbereich}));e?e.rubriken.push(t.attributes.Rubrik):n.push({id:t.attributes.Unterbereich,rubriken:[t.attributes.Rubrik]})}),(0,p.createFilterPanel)(r,n)}).catch(function(e){console.error("Error query Rubriken for FilterPanel",e),(0,p.createFilterPanel)(null,null)})),new a.default({expandIconClass:"esri-icon-filter",expandTooltip:"Filter nach Hauptsäule",view:v,content:document.getElementById("filterNode"),group:"top-left"}));o.when(function(){var e=document.querySelectorAll(".esri-collapse__icon.esri-icon-filter");0<e.length&&(b=e[0])}),v.ui.add({component:o,position:"top-left",index:0})}),new n.default({container:"viewDiv",map:y})),i=(v.on("mouse-wheel",function(e){var t;e.native.ctrlKey||(e.stopPropagation(),(t=document.getElementById("warning")).innerHTML='<div class="message">Zum Zoomen bitte Strg-Taste und Mausrad benutzen</div>',t.style.opacity="1",h&&window.clearTimeout(h),h=window.setTimeout(function(){t.style.opacity="0",t.innerHTML=""},4e3))}),v.highlightOptions.color=new r.default("#1e1e1e"),v.highlightOptions.haloOpacity=0,v.highlightOptions.fillOpacity=.5,v.popup.dockOptions={buttonEnabled:!1,breakpoint:{width:600,height:900}},new l.default({view:v,allPlaceholder:"Adresse oder Standort",popupEnabled:!1,resultGraphicEnabled:!1})),n=new a.default({expandIconClass:"esri-icon-search",view:v,content:i,group:"top-left"}),r=(v.ui.add(n,"top-left"),new o.default({view:v}));function k(e,t,r){var n,i;null!==t?0<(i=document.getElementsByClassName(e)).length&&(n=i.item(0)):null!=(i=document.getElementById(e))&&(n=i),n&&(n.onclick=function(){var e=c.createQuery();e.aggregateIds=[r],null!=t&&(e.where="Hauptsäule = '"+t+"'",E(e.where),(0,p.updateCheckBoxesForFilter)(!0,t)),c.queryExtent(e).then(function(e){null!=e&&null!=e.extent&&v.goTo(e.extent)}).catch(function(e){console.error("Error QueryExtent",e)})})}function E(e){var t="",t=f?f+" AND "+w+" AND "+e:w+" AND "+e;g.forEach(function(e){e.definitionExpression=t,e.refresh()})}v.ui.add(r,"top-left"),v.on("pointer-move",function(e){v.popup.open&&0<v.popup.featureCount&&v.popup.features[0].layer!==d||v.hitTest(e,{include:[d]}).then(function(e){0<e.results.length?"graphic"===e.results[0].type&&(0<v.popup.featureCount&&v.popup.features[0].attributes.objectid===e.results[0].graphic.attributes.objectid?v.popup.location=e.results[0].mapPoint:(v.popup.container.normalize(),v.popup.dockEnabled=!1,v.popup.open({features:[e.results[0].graphic],location:e.results[0].mapPoint}))):v.popup.visible&&(v.popup.close(),v.size[1]<v.popup.dockOptions.breakpoint.height)&&(v.popup.dockEnabled=!0)})}),v.popup.watch("selectedFeature",function(t){var e,r;t&&(0<(null==(e=(r=t.getEffectivePopupTemplate()).actions)?void 0:e.items.length)?r.actions.items[0].visible=!!t.attributes.Standortdomaine:t.layer.title&&0<=t.layer.title.indexOf("Cluster")&&new Promise(function(e){return setTimeout(e,2e3)}).then(function(e){k("clusterPopup-countRohstoffe","Rohstoffe + Logistik",t.getObjectId()),k("clusterPopup-countBau","Bau + Projekte",t.getObjectId()),k("clusterPopup-countRecycling","Recycling + Verwertung",t.getObjectId()),k("clusterPopup-countTechnologie","Technologie + Produkte",t.getObjectId()),k("clusterPopup",null,t.getObjectId())}))}),v.popup.on("trigger-action",function(e){e.action.id===s.actionID&&(e=v.popup.viewModel.selectedFeature.attributes.Standortdomaine)&&window.open(e.trim(),"_blank")}),v.popup.watch("features",function(e){var r;1<e.length?m?(r=[],e.forEach(function(t){r.find(function(e){return t.attributes.Standort+"_"+t.attributes.Gesellschaft==e.attributes.Standort+"_"+e.attributes.Gesellschaft})||r.push(t)}),m=!1,v.popup.features=r):m=!0:1===e.length&&0<=(null==(e=e[0].layer.title)?void 0:e.indexOf("Standort"))?v.size[1]<v.popup.dockOptions.breakpoint.height&&!v.popup.dockEnabled&&(v.popup.dockEnabled=!0):m=m||!0}),"xsmall"===v.widthBreakpoint||"small"===v.widthBreakpoint?v.constraints.minZoom=5:v.constraints.minZoom=6,v.constraints.maxZoom=15,t.setFilter=E,t.updateFilterIcon=function(r){b?r?b.style.setProperty("color","#ffcc00"):b.style.setProperty("color","#adadad"):new Promise(function(e){return setTimeout(e,2e3)}).then(function(e){var t=document.querySelectorAll(".esri-collapse__icon.esri-icon-filter");0<t.length&&(b=t[0],r?b.style.setProperty("color","#ffcc00"):b.style.setProperty("color","#adadad"))})}});