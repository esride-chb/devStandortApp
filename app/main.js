var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define(["require","exports","esri/Color","esri/rest/support/Query","esri/views/MapView","esri/WebMap","esri/widgets/Expand","esri/widgets/Locate","./filter","./popup"],function(e,t,n,u,o,i,p,r,a,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.setFilter=void 0,n=__importDefault(n),u=__importDefault(u),o=__importDefault(o),i=__importDefault(i),p=__importDefault(p),r=__importDefault(r);var s,c,d,f,h=!0,b=[],g=new i.default({portalItem:{id:"02fbadc5dd45470487dbcc9b998c1dc1"}}),m=(g.when().then(function(){for(var e,t=[],n=decodeURI(window.location.search).substring(1).split("&"),o=0;o<n.length;o++)0<n[o].length&&(e=n[o].split("="),t.push({attribute:e[0],value:e[1]}));var i="1=1",r=(t.forEach(function(e){i=i+" AND ("+e.attribute+"='"+e.value+"')","Hauptsäule"===e.attribute?(0,a.updateCheckBoxesForFilter)(!0,e.value):"Unterbereich"===e.attribute&&(0,a.updateCheckBoxesForFilter)(!1,e.value)}),g.layers.forEach(function(e){var t;"feature"===e.type?0<=(t=e).url.indexOf("Standort")?(t.definitionExpression?(d=t.definitionExpression,t.definitionExpression=t.definitionExpression+"AND ("+i+")"):t.definitionExpression=i,null!==t.featureReduction&&(t.featureReduction.popupEnabled=!0,t.featureReduction.popupTemplate=l.popupTemplateCluster,m.whenLayerView(e).then(function(e){s=e})),t.popupTemplate=l.popupTemplateStandort,b.push(t)):(t.popupTemplate=void 0,t.popupEnabled=!1,0<=t.url.indexOf("Regionen")&&(t.popupTemplate=l.popupTemplateRegionen,c=t)):"group"===e.type&&e.layers.forEach(function(e){0<=e.url.indexOf("Standort")?(e.definitionExpression?e.definitionExpression=e.definitionExpression+" AND ("+i+")":e.definitionExpression=i,e.popupTemplate=l.popupTemplateStandort,b.push(e)):e.popupTemplate=void 0})}),new u.default),r=(r.where=i,r.outFields=["*"],r.returnGeometry=!1,0<b.length&&null!=b[0]&&b[0].queryFeatures(r).then(function(e){e.features.forEach(function(t){var e;null!=t.attributes.Unterbereich&&((e=l.rubrikenForStandort.find(function(e){return e.id===t.attributes.Standort+"_"+t.attributes.Gesellschaft}))?(console.log("Already in List"),e.rubriken.find(function(e){return e.name===t.attributes.Unterbereich})||e.rubriken.push({name:t.attributes.Unterbereich,url:t.attributes.Unterbereichsdomaine})):l.rubrikenForStandort.push({id:t.attributes.Standort+"_"+t.attributes.Gesellschaft,rubriken:[{name:t.attributes.Unterbereich,url:t.attributes.Unterbereichsdomaine}]}))})}).catch(function(e){console.error("Error query Rubriken",e)}),new p.default({expandIconClass:"esri-icon-filter",expandTooltip:"Filter nach Hauptsäule",view:m,content:a.filterNode}));m.ui.add(r,"top-left")}),new o.default({container:"viewDiv",map:g})),i=(m.on("mouse-wheel",function(e){var t;e.native.ctrlKey||(e.stopPropagation(),(t=document.getElementById("warning")).innerHTML='<div class="message">Zum Zoomen bitte Strg-Taste und Mausrad benutzen</div>',t.style.opacity="1",f&&window.clearTimeout(f),f=window.setTimeout(function(){t.style.opacity="0",t.innerHTML=""},4e3))}),m.highlightOptions.color=new n.default("#1e1e1e"),m.highlightOptions.haloOpacity=0,m.highlightOptions.fillOpacity=.5,m.popup.dockOptions={buttonEnabled:!1,breakpoint:{width:600,height:900}},new r.default({view:m}));function v(e,t,n){var o,i;null!==t?0<(i=document.getElementsByClassName(e)).length&&(o=i.item(0)):null!=(i=document.getElementById(e))&&(o=i),o&&(o.onclick=function(){var e=s.createQuery();e.aggregateIds=[n],null!=t&&(e.where="Hauptsäule = '"+t+"'",w(e.where),(0,a.updateCheckBoxesForFilter)(!0,t)),s.queryExtent(e).then(function(e){null!=e&&null!=e.extent&&m.goTo(e.extent)}).catch(function(e){console.error("Error QueryExtent",e)})})}function w(e){var t="",t=d?d+" AND "+e:e;console.log(t),b.forEach(function(e){e.definitionExpression=t,e.refresh()})}m.ui.add(i,"top-left"),m.on("pointer-move",function(e){m.popup.open&&0<m.popup.featureCount&&m.popup.features[0].layer!==c||m.hitTest(e,{include:[c]}).then(function(e){0<e.results.length?"graphic"===e.results[0].type&&(0<m.popup.featureCount&&m.popup.features[0].attributes.objectid===e.results[0].graphic.attributes.objectid?m.popup.location=e.results[0].mapPoint:(m.popup.container.normalize(),m.popup.dockEnabled=!1,m.popup.open({features:[e.results[0].graphic],location:e.results[0].mapPoint}))):m.popup.visible&&(m.popup.close(),m.size[1]<m.popup.dockOptions.breakpoint.height)&&(m.popup.dockEnabled=!0)})}),m.popup.watch("selectedFeature",function(t){var e,n;t&&(0<(null==(e=(n=t.getEffectivePopupTemplate()).actions)?void 0:e.items.length)?n.actions.items[0].visible=!!t.attributes.Standortdomaine:0<=t.layer.title.indexOf("Cluster")&&new Promise(function(e){return setTimeout(e,2e3)}).then(function(e){v("clusterPopup-countRohstoffe","Rohstoffe + Logistik",t.getObjectId()),v("clusterPopup-countBau","Bau + Projekte",t.getObjectId()),v("clusterPopup-countRecycling","Recycling + Verwertung",t.getObjectId()),v("clusterPopup-countTechnologie","Technologie + Produkte",t.getObjectId()),v("clusterPopup",null,t.getObjectId())}))}),m.popup.on("trigger-action",function(e){e.action.id===l.actionID&&(e=m.popup.viewModel.selectedFeature.attributes.Standortdomaine)&&window.open(e.trim(),"_blank")}),m.popup.watch("features",function(e){var n;1<e.length?h?(n=[],e.forEach(function(t){n.find(function(e){return t.attributes.Standort+"_"+t.attributes.Gesellschaft==e.attributes.Standort+"_"+e.attributes.Gesellschaft})||n.push(t)}),h=!1,n.length<e.length&&(console.log(n),console.log(e)),m.popup.features=n):h=!0:1===e.length&&0<=(null==(e=e[0].layer.title)?void 0:e.indexOf("Standort"))&&m.size[1]<m.popup.dockOptions.breakpoint.height&&!m.popup.dockEnabled&&(m.popup.dockEnabled=!0)}),m.constraints.minZoom=6,t.setFilter=w});