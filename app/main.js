var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};define(["require","exports","esri/Color","esri/rest/support/Query","esri/views/MapView","esri/WebMap","esri/widgets/Locate","./popup"],function(e,t,i,p,n,o,r,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i=__importDefault(i),p=__importDefault(p),n=__importDefault(n),o=__importDefault(o),r=__importDefault(r);var a,s,l=!0,d=[],c=new o.default({portalItem:{id:"02fbadc5dd45470487dbcc9b998c1dc1"}}),f=(c.when().then(function(){for(var e,t=[],i=decodeURI(window.location.search).substring(1).split("&"),n=0;n<i.length;n++)0<i[n].length&&(e=i[n].split("="),t.push({attribute:e[0],value:e[1]}));var o="1=1",r=(t.forEach(function(e){o=o+" AND ("+e.attribute+"='"+e.value+"')"}),c.layers.forEach(function(e){var t;"feature"===e.type?0<=(t=e).url.indexOf("Standort")?(t.definitionExpression?t.definitionExpression=t.definitionExpression+"AND ("+o+")":t.definitionExpression=o,null!==t.featureReduction&&(t.featureReduction.popupEnabled=!0,t.featureReduction.popupTemplate=u.popupTemplateCluster),t.popupTemplate=u.popupTemplateStandort,d.push(t)):(t.popupTemplate=void 0,t.popupEnabled=!1,0<=t.url.indexOf("Regionen")&&(t.popupTemplate=u.popupTemplateRegionen,a=t)):"group"===e.type&&e.layers.forEach(function(e){0<=e.url.indexOf("Standort")?(e.definitionExpression?e.definitionExpression=e.definitionExpression+" AND ("+o+")":e.definitionExpression=o,e.popupTemplate=u.popupTemplateStandort,d.push(e)):e.popupTemplate=void 0})}),new p.default);r.where=o,r.outFields=["*"],r.returnGeometry=!1,0<d.length&&null!=d[0]&&d[0].queryFeatures(r).then(function(e){e.features.forEach(function(t){var e;null!=t.attributes.Unterbereich&&((e=u.rubrikenForStandort.find(function(e){return e.id===t.attributes.Standort+"_"+t.attributes.Gesellschaft}))?(console.log("Already in List"),e.rubriken.find(function(e){return e.name===t.attributes.Unterbereich})||e.rubriken.push({name:t.attributes.Unterbereich,url:t.attributes.Unterbereichsdomaine})):u.rubrikenForStandort.push({id:t.attributes.Standort+"_"+t.attributes.Gesellschaft,rubriken:[{name:t.attributes.Unterbereich,url:t.attributes.Unterbereichsdomaine}]}))})}).catch(function(e){console.error("Error query Rubriken",e)})}),new n.default({container:"viewDiv",map:c})),t=(f.on("mouse-wheel",function(e){var t;e.native.ctrlKey||(e.stopPropagation(),(t=document.getElementById("warning")).innerHTML='<div class="message">Zum Zoomen bitte Strg-Taste und Mausrad benutzen</div>',t.style.opacity="1",s&&window.clearTimeout(s),s=window.setTimeout(function(){t.style.opacity="0",t.innerHTML=""},4e3))}),f.highlightOptions.color=new i.default("#1e1e1e"),f.highlightOptions.haloOpacity=0,f.highlightOptions.fillOpacity=.5,f.popup.dockOptions={buttonEnabled:!1,breakpoint:{width:600,height:900}},new r.default({view:f}));f.ui.add(t,"top-left"),f.on("pointer-move",function(e){f.popup.open&&0<f.popup.featureCount&&f.popup.features[0].layer!==a||f.hitTest(e,{include:[a]}).then(function(e){0<e.results.length?"graphic"===e.results[0].type&&(0<f.popup.featureCount&&f.popup.features[0].attributes.objectid===e.results[0].graphic.attributes.objectid?f.popup.location=e.results[0].mapPoint:(f.popup.container.normalize(),f.popup.dockEnabled=!1,f.popup.open({features:[e.results[0].graphic],location:e.results[0].mapPoint}))):f.popup.visible&&(f.popup.close(),f.size[1]<f.popup.dockOptions.breakpoint.height)&&(f.popup.dockEnabled=!0)})}),f.popup.watch("selectedFeature",function(e){var t,i;e&&0<(null==(t=(i=e.getEffectivePopupTemplate()).actions)?void 0:t.items.length)&&(i.actions.items[0].visible=!!e.attributes.Standortdomaine)}),f.popup.on("trigger-action",function(e){e.action.id===u.actionID&&(e=f.popup.viewModel.selectedFeature.attributes.Standortdomaine)&&window.open(e.trim(),"_blank")}),f.popup.watch("features",function(e){var i;1<e.length?l?(i=[],e.forEach(function(t){i.find(function(e){return t.attributes.Standort+"_"+t.attributes.Gesellschaft==e.attributes.Standort+"_"+e.attributes.Gesellschaft})||i.push(t)}),l=!1,i.length<e.length&&(console.log(i),console.log(e)),f.popup.features=i):l=!0:1===e.length&&0<=(null==(e=e[0].layer.title)?void 0:e.indexOf("Standort"))&&f.size[1]<f.popup.dockOptions.breakpoint.height&&!f.popup.dockEnabled&&(f.popup.dockEnabled=!0)}),f.constraints.minZoom=6});